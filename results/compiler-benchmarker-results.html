<html>

<head>
  <meta charset="utf-8" />
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.0.0/dygraph.min.js" integrity="sha384-7GkOXVYF0XSclperhm8baNtpMGCjiO+pxUeJofevmxRplT9j0OPEQVJ3XK59KEKi" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dygraph/2.0.0/dygraph.min.css" integrity="sha384-87RI/ohPyciweUFQBSb6FIoq7ACWHPWXRbUIdvkodQ4gY+0BT5Y8MWG96w5GN/lE" crossorigin="anonymous">
</head>

<body>
  <style>
    .dygraph-legend {
      left: 70px !important;
      width: 275px;
      background-color: transparent;
    }
    .dygraph-legend > span {
      display: block;
    }
    .dygraph-legend > span.highlight {
      border-radius: 1px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.5);
      background-color: rgba(0, 0, 0, 0.03);
    }
    body {
      background-color: #ebebeb;
      margin: 30px;
    }
    #all-compiler-select {
      margin-top: 20px;
      width: 800px;
    }
    #chart {
      height: 600px;
      width: 930;
    }
    #graph-toggle-controls {
      margin-top: 15px;
      width: 800px;
    }
    #graph-toggle-controls div {
      margin-top: 3px;
      display: inline-block;
    }
    #graph-toggle-controls div > button:nth-child(2) {
      margin-right: 15px;
    }
    .toggle-compiler {
      margin-right: 5px;
      display: inline-block;
    }
  </style>

  <div class="content">
    <div id="chart"></div>

    <div id="graph-toggle-controls">
      <div>
        <button id="show-all">Show All</button>
        <button id="hide-all">Hide All</button>
      </div>
      <div>
        <button id="show-optimized">Show Opt</button>
        <button id="hide-optimized">Hide Opt</button>
      </div>
      <div>
        <button id="show-nonoptimized">Show Non-Opt</button>
        <button id="hide-nonoptimized">Hide Non-Opt</button>
      </div>
      <div>
        <button id="show-native">Show Native</button>
        <button id="hide-native">Hide Native</button>
      </div>
      <div>
        <button id="show-vm">Show VM</button>
        <button id="hide-vm">Hide VM</button>
      </div>
      <div>
        <button id="show-functional">Show Functional</button>
        <button id="hide-functional">Hide Functional</button>
      </div>
      <div id="all-compiler-select"></div>
    </div>
  </div>

</body>

<script>

String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.replace(new RegExp(search, 'g'), replacement);
};

$(function(event) {

  var graph = new Dygraph(document.getElementById('chart'), "results_20171015T110305_final_noversion.csv", {
    legend: 'always',
    title: 'Compiler Timings vs. Number of Functions',
    ylabel: 'Time (seconds)',
    xlabel: 'Function count',
    xRangePad: 50,
    highlightSeriesOpts: {
      strokeWidth: 3,
      strokeBorderWidth: 1,
      highlightCircleSize: 5
    }
  });

  graph.ready(function() {

    var labels = graph.getLabels();
    var native = ['C ', 'C++', 'Rust', 'D', 'OCaml', 'Haskell', 'Go'];
    var vm = ['Java', 'CSharp', 'FSharp', 'Scala', 'Kotlin'];
    var functional = [ 'Fsharp', 'Haskell', 'OCaml'];
    var optflags = ['-C', '-o', '-O', '/o']
    var showhide = {};
    for (var i = 1; i < labels.length; i++) {
      showhide[i] = true;
    }

    function toggleCompiler(index, show) {
      index = parseInt(index);
      showhide[index] = show;
      graph.setVisibility(index - 1, showhide[index]);
    }

    function toggleAll(show) {
      for (var i in showhide) {
        showhide[i] = show;
      }
      renderShowHide();
    }

    function toggleFrom(containing, show, opposite) {
       var labelmatches = labels
        .map(function(v, i) {
          if (i == 0)
            return null;
          else if (opposite)
            return !containing.some(function(search) { return v.indexOf(search) >= 0; })
              ? { label: v, index: i } : null;
          else
            return containing.some(function(search) { return v.indexOf(search) >= 0; })
              ? { label: v, index: i } : null;
        })
        .filter(function (v) { return v !== null; });

      console.log(labels);
      console.log(containing);
      console.log('Show: ', show);
      console.log(labelmatches.map(function (v) { return v.label; }));

      for (var i = 0; i < labelmatches.length; i++) {
        showhide[labelmatches[i].index] = show;
      }

      renderShowHide();
    }

    function toggleNative(show) {
      toggleFrom(native, show);
    }

    function toggleVm(show) {
      toggleFrom(vm, show);
    }

    function toggleOptimized(show) {
      toggleFrom(optflags, show);
    }

    function toggleNonOptimized(show) {
      toggleFrom(optflags, show, true);
    }

    function toggleFunctional(show) {
      toggleFrom(functional, show);
    }

    function toggleLanguage(lang, show) {
      toggleFrom([lang], show);
    }

    function renderShowHide() {
      var $allCompilerSelect = $('#all-compiler-select');
      var inputs = [];
      for (var i in showhide) {
        inputs.push(
          '<span class="toggle-compiler"><input id="lang{i}" type="checkbox" {checked} class="toggle-compiler-check" data-index="{i}" /><label for="lang{i}">{label}</label></span>'
            .replaceAll('{i}', i)
            .replace('{label}', labels[i])
            .replace('{checked}', showhide[i] ? 'checked' : ''));
        toggleCompiler(i, showhide[i]);
      }
      $allCompilerSelect.empty();
      $allCompilerSelect.append($(inputs.join('')));
      $('.toggle-compiler-check').click(function(el) {
        var index = $(el.currentTarget).attr('data-index');
        showhide[index] = $(el.currentTarget).prop('checked');
        toggleCompiler(index, showhide[index]);
      });
    }

    renderShowHide();

    $('#show-all').click(function() { toggleAll(true); })
    $('#hide-all').click(function() { toggleAll(false); })
    $('#show-optimized').click(function() { toggleOptimized(true); })
    $('#hide-optimized').click(function() { toggleOptimized(false); })
    $('#show-nonoptimized').click(function() { toggleNonOptimized(true); })
    $('#hide-nonoptimized').click(function() { toggleNonOptimized(false); })
    $('#show-native').click(function() { toggleNative(true); })
    $('#hide-native').click(function() { toggleNative(false); })
    $('#show-vm').click(function() { toggleVm(true); })
    $('#hide-vm').click(function() { toggleVm(false); })
    $('#show-functional').click(function() { toggleFunctional(true); })
    $('#hide-functional').click(function() { toggleFunctional(false); })
  });
});

</script>
</html>